<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rwasm">
<title>Mounting filesystem images • rwasm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mounting filesystem images">
<meta property="og:description" content="rwasm">
<meta property="og:image" content="https://r-wasm.github.io/rwasm/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rwasm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rwasm.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/mount-fs-image.html">Mounting filesystem images</a>
    <a class="dropdown-item" href="../articles/mount-host-dir.html">Mounting host directories in node</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-wasm/rwasm/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Mounting filesystem images</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-wasm/rwasm/blob/HEAD/vignettes/mount-fs-image.Rmd" class="external-link"><code>vignettes/mount-fs-image.Rmd</code></a></small>
      <div class="d-none name"><code>mount-fs-image.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The Emscripten WebAssembly environment provides a virtual filesystem
(VFS) which supports the concept of <em>mounting</em>. With this, an
entire file and directory structure can be packaged into a filesystem
image to be loaded and mounted at runtime by WebAssembly (Wasm)
applications. We can take advantage of this interface to efficiently
mount R package libraries, pre-packaged and containing potentially many
related R packages, in the VFS accessible to webR.</p>
</div>
<div class="section level2">
<h2 id="building-an-r-package-library">Building an R package library<a class="anchor" aria-label="anchor" href="#building-an-r-package-library"></a>
</h2>
<p>To build an R package library image we must first build one or more
Wasm R packages using <code><a href="../reference/add_pkg.html">add_pkg()</a></code>. As an example, let’s build
a package with a few hard dependencies. Ensure that you are running R in
an environment with access to Wasm development tools<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;See the “Setting up the WebAssembly toolchain” section
in &lt;code&gt;&lt;a href="../articles/rwasm.html"&gt;vignette("rwasm")&lt;/a&gt;&lt;/code&gt; for further details.&lt;/p&gt;'><sup>1</sup></a>, then run:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rwasm</span><span class="fu">::</span><span class="fu"><a href="../reference/add_pkg.html">add_pkg</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span></code></pre></div>
<p>After the build process has completed, the new <code>repo</code>
directory contains a CRAN-like package repository with R packages build
for Wasm.</p>
<p>Next, run the following to build an Emscripten VFS image:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rwasm</span><span class="fu">::</span><span class="fu"><a href="../reference/make_vfs_library.html">make_vfs_library</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>By default, this function will create a new directory named
<code>vfs</code> if it does not exist. The files
<code>vfs/library.data</code> and <code>vfs/library.js.metadata</code>
together form an Emscripten filesystem image containing an R package
library consisting of all the packages previously added to the CRAN-like
repository in <code>repo</code> using <code><a href="../reference/add_pkg.html">add_pkg()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="mounting-filesystem-images">Mounting filesystem images<a class="anchor" aria-label="anchor" href="#mounting-filesystem-images"></a>
</h2>
<p>The filesystem image should now be hosted by a web server so that it
is available at some URL. Such a URL can then be passed to
<code>webr::mount()</code> to be made available somewhere on the virtual
filesystem for the Wasm R process.</p>
<div class="section level3">
<h3 id="local-testing">Local testing<a class="anchor" aria-label="anchor" href="#local-testing"></a>
</h3>
<p>The following R command starts a local web server to serve your
filesystem image for testing<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Ensure that the latest version of the
&lt;code&gt;httpuv&lt;/code&gt; package is installed so that the
&lt;code&gt;?httpuv::runStaticServer&lt;/code&gt; function is available.&lt;/p&gt;"><sup>2</sup></a>. When serving your files locally, be sure
to include the <code>Access-Control-Allow-Origin: *</code> HTTP header,
required for downloading files from a cross-origin server by the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" class="external-link">CORS</a>
mechanism.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httpuv</span><span class="fu">::</span><span class="fu">runStaticServer</span><span class="op">(</span></span>
<span>  dir <span class="op">=</span> <span class="st">"."</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">9090</span>,</span>
<span>  browse <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  headers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Access-Control-Allow-Origin"</span> <span class="op">=</span>  <span class="st">"*"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Once the web server is running start a webR session in your browser,
such as the console at <a href="https://webr.r-wasm.org/latest/" class="external-link uri">https://webr.r-wasm.org/latest/</a>. Use
<code>webr::mount()</code> to make the R library image available
somewhere on the VFS<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;You might need to adjust the path portion of the URL,
depending on your set-up. If it does not work, you could also try
&lt;code&gt;"http://127.0.0.1:9090"&lt;/code&gt; or
&lt;code&gt;"http://127.0.0.1:9090/output/vfs"&lt;/code&gt;&lt;/p&gt;'><sup>3</sup></a>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">webr</span><span class="fu">::</span><span class="fu">mount</span><span class="op">(</span><span class="st">"/my-library"</span>, <span class="st">"http://127.0.0.1:9090/vfs/library.data"</span><span class="op">)</span></span></code></pre></div>
<p>Once mounted, the contents of the filesystem image are available at
<code>/my-library</code> in the virtual filesystem.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"/my-library"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "R6"         "cli"        "dplyr"      "fansi"      "generics"   "glue"</span></span>
<span><span class="co">#&gt;  [7] "lifecycle"  "magrittr"   "pillar"     "pkgconfig"  "rlang"      "tibble"</span></span>
<span><span class="co">#&gt; [13] "tidyselect" "utf8"       "vctrs"      "withr"</span></span></code></pre></div>
<p>This new directory should be added to R’s <code><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths()</a></code>,
so that R packages may be loaded from the new library.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/my-library"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Attaching package: ‘dplyr’</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The following objects are masked from ‘package:stats’:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The following objects are masked from ‘package:base’:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deployment">Deployment<a class="anchor" aria-label="anchor" href="#deployment"></a>
</h3>
<p>The filesystem image files should be deployed to the static file
hosting service of your choice, so that they are available for download
anywhere. See the “Deployment to static hosting” section in
<code><a href="../articles/rwasm.html">vignette("rwasm")</a></code> for an example of how to host static
files with GitHub pages, substituting the <code>repo</code> directory
for the <code>vfs</code> directory in the example.</p>
</div>
<div class="section level3">
<h3 id="packaging-other-data">Packaging other data<a class="anchor" aria-label="anchor" href="#packaging-other-data"></a>
</h3>
<p>Other arbitrary data in the form of files and directories can be
packaged for mounting using the same method described above with the
<code><a href="../reference/file_packager.html">rwasm::file_packager()</a></code> function.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by George Stagg, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
